package mybot

import (
	"database/sql"
	"fmt"
	"log"
	"math/rand"
	"net/http"
	"strings"
	"sync"
	"time"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

// ะะฐััะธะฒั ััะฐะท ะดะปั ัะฐัััะปะบะธ (ัะตะฟะตัั ะฝะต ะบะพะฝััะฐะฝัั, ะฐ ะผะฐััะธะฒั ะดะปั ัะปััะฐะนะฝะพะน ะฒัะฑะพัะบะธ)
var broadcastPhrases1 = []string{
	// ะะตัะฒัะต 10
	"ะะพะทะดัะฐะฒะปัะตะผ ั ััะธะผ ะฟะพัััะฝัะผ ะทะฒะฐะฝะธะตะผ! ๐ท๐ถ",
	"ะัะธะฒะตัััะฒัะตะผ ะฝะพะฒะพะณะพ ะฟะพะฒะตะปะธัะตะปั ะณััะทะธ ะธ ะฒะธะปัะฝะธั ัะฒะพััะพะผ! ๐ท๐๐ถ",
	"ะะฟะปะพะดะธััะตะผ ะฒะพััะพะถะดะตะฝะธั ะฝะฐ ััะพะฝ ัััะบะฐััะธั ะธ ะณะฐะฒะบะฐััะธั! ๐๐ฝ๐",
	"ะงะตััั ะธ ัะฒะฐะปะฐ ัะฐัั/ัะฐัะธัะต ัะฒะธะฝะพ-ัะพะฑะฐััะตะณะพ ะฟะปะตะผะตะฝะธ! ๐๐๐ฆฎ",
	"ะะฐั! ะขั ะพัะธัะธะฐะปัะฝะพ ะณะปะฐะฒะฝัะน ะณะธะฑัะธะด ัะฐัะฐั ะธ ะบะพะฝััั! ๐ฏ๐ท๐๐ถ",
	"ะัะฐะฒะพ! ะขั ะดะพััะธะณ ะฒะตััะธะฝั ัะฒะพะปััะธะธ - ัะฒะธะฝะพัะพะฑะฐะบะฐ! ๐๐โ๐ถ",
	"ะะพะธ ัะพะฑะพะปะตะทะฝะพะฒะฐะฝะธั... ะพะน, ัะพ ะตััั ะฟะพะทะดัะฐะฒะปะตะฝะธั! ๐๐ทโค๏ธ๐ถ",
	"ะขั ัะดะพััะพะตะฝ(ะฐ) ะฒัััะตะน ะฝะฐะณัะฐะดั ะฒ ะฝะพะผะธะฝะฐัะธะธ 'ะฅัั-ะณะฐะฒ'! ๐๐ฝ๐",
	"ะะพะฑัะพ ะฟะพะถะฐะปะพะฒะฐัั ะฒ ัะปะธัะฝัะน ะบะปัะฑ ะณััะทะธ ะธ ัะปัะฝะตะน! ๐ช๐ท๐คค๐ถ",
	"ะขั ัะตะฟะตัั ะปะตะณะตะฝะดะฐ ััะตะดะธ ัััะตััะฒ ั ััะฐะผะธ ะธ ะฟััะฐัะบะฐะผะธ! ๐๐๐ฝ",

	// ะกะปะตะดัััะธะต 30
	"ะขั ะพัะธัะธะฐะปัะฝะพ ัะดะพััะพะตะฝ(ะฐ) ะทะฒะฐะฝะธั 'ะฅะพะดััะธะน ะพะบััะผะพัะพะฝ'! ๐คน๐ท+๐ถ",
	"ะัะฐัะธัะบะฐ/ัะตััััะฝะบะฐ, ัั ัะตะฟะตัั ะถะธะฒะฐั ะทะฐะณะฐะดะบะฐ ะฟัะธัะพะดั! ๐งฉ๐โ๐",
	"ะัะตะปะตะฝะฝะฐั ัะบะฐะทะฐะปะฐ 'ะดะฐ' ัะฒะพะตะผั ัะฒะธะฝะพะปะฐั! ๐โ๐ท๐",
	"ะขั - ะถะธะฒะพะต ะดะพะบะฐะทะฐัะตะปัััะฒะพ, ััะพ ะปัะฑะพะฒั ัะปะตะฟะฐ! ๐ฉโโค๏ธโ๐จ๐ท๐๐ถ",
	"ะะพัะพะฝัะนัั, ะผะพะฝะฐัั ะณััะทะธ ะธ ะฒะธะปัะฝะธั! ๐๐โ๏ธ๐",
	"ะขั ะฟะพะฑะตะดะธะป(ะฐ) ะฒ ะณะตะฝะตัะธัะตัะบะพะน ะปะพัะตัะตะต! ๐งฌ๐ฐ๐ท๐ถ",
	"ะขะตะฟะตัั ัั ะผะพะถะตัั ััะตะฑะพะฒะฐัั ัะบะธะดะบะธ ะธ ะฒ ะฒะตัะบะปะธะฝะธะบะต, ะธ ะฝะฐ ัะฒะธะฝะพัะตัะผะต! ๐ธ๐ฅ๐+๐ฅ๐",
	"ะกะฐะปัั ะฝะพะฒะพะผั ัะตะผะฟะธะพะฝั ะผะธัะฐ ะฟะพ ัััะบะฐะฝัั ะธ ะปะฐั! ๐ฅ๐๐ท๐ข๐ถ",
	"ะขั - ะทะพะปะพัะฐั ัะตัะตะดะธะฝะฐ ะผะตะถะดั ัะฐะฒัะธะบะพะผ ะธ ะฟะตัะตะฝัะบะพะน! ๐ฅ๐ท๐+๐ช๐ถ",
	"ะขะฒะพะธ ะฟัะตะดะบะธ ะณะพัะดัััั (ะธะปะธ ะฒ ัะพะบะต)! ๐ป๐๐ฒ๐บ",
	"ะขั ัะตะฟะตัั ะทะฝะฐะผะตะฝะธัะพััั ะฒ ะผะธัะต ะณะธะฑัะธะดะฝัั ัััะตััะฒ! ๐ธ๐๐ท๐",
	"ะัะธะฒะตัััะฒัะตะผ ะฝะพะฒะพะณะพ ะธะผะฟะตัะฐัะพัะฐ/ะธะผะฟะตัะฐััะธัั ะกะฒะธะฝะพะปะฐะฝะธะธ! ๐๐ท๐ฐ๐ถ",
	"ะขั ะดะพััะธะณ(ะปะฐ) ะฝะธัะฒะฐะฝั ัััะบะฐััะต-ะณะฐะฒะบะฐััะตะณะพ ะฟัะพัะฒะตัะปะตะฝะธั! ๐งโโ๏ธ๐ทโฏ๏ธ๐ถ",
	"ะญัะพ ะทะฒะฐะฝะธะต ะฒะฐะถะฝะตะต, ัะตะผ ะดะพะบัะพััะบะฐั ััะตะฟะตะฝั! ๐<๐ท๐ถ",
	"ะขั ัะตะฟะตัั ัะบัะฟะตัั ะฟะพ ะณััะทะตะฒัะผ ะฒะฐะฝะฝะฐะผ ะธ ะฟะพะณะพะฝัะผ ะทะฐ ัะฒะพััะพะผ! ๐๐ท+๐๐",
	"ะะพะปะปะตะบัะธะฒ ัะฐัะฐั ะธ ะบะพะฝััั ะฐะฟะปะพะดะธััะตั! ๐๐ท๐๏ธ+๐๐",
	"ะขั - ะถะธะฒะพะต ะฒะพะฟะปะพัะตะฝะธะต 'ะดะฒะฐ ะฒ ะพะดะฝะพะผ'! 2๏ธโฃโก๏ธ1๏ธโฃ๐ท๐ถ",
	"ะญัะพ ะทะฒะฐะฝะธะต ัะฒะตัะธั ัััะต ัะตะฒะตัะฝะพะณะพ ัะธัะฝะธั! ๐๐ทโจ๐ถ",
	"ะขั ะฟะตัะตัะตะป(ะปะฐ) ะฝะฐ ัะตะผะฝัั ััะพัะพะฝั ัะธะปั... ัะฒะธะฝัััะตะน! โซ๐ท๐๐ถ",
	"ะขะตะฟะตัั ัั ะผะพะถะตัั ะฟัะตัะตะฝะดะพะฒะฐัั ะฝะฐ ะดะฒะพะนะฝะพะต ะณัะฐะถะดะฐะฝััะฒะพ: ะกะฒะธะฝะธั ะธ ะกะพะฑะฐะบะธั! ๐ธ๐ป+๐ฉ๐ฌ๐ท๐ถ",
	"ะัะฐะฒะพ, ะบะฐะฟะธัะฐะฝ ะบะพัะฐะฑะปั 'ะกะฒะธะฝะพ-ะกะพะฑะฐััะต ะะดะธะฝััะฒะพ'! โต๐ท๐จโโ๏ธ๐ถ",
	"ะขั - ัะตะดะบะธะน ัะบะทะตะผะฟะปัั ะฒ ะบัะฐัะฝะพะน ะบะฝะธะณะต ัััะฐะฝะฝะพััะตะน! ๐๐ท๐ด๐ถ",
	"ะญัะพ ะบัััะต, ัะตะผ ะฑััั ะฟะพะปััะตะปะพะฒะตะบะพะผ-ะฟะพะปัะบะพะฝะตะผ! ๐<๐ท๐ถ",
	"ะขั ัะตะฟะตัั ะผะพะถะตัั ัะฐะทะณะพะฒะฐัะธะฒะฐัั ะฝะฐ ะดะฒัั ัะทัะบะฐั: ััั ะธ ะณะฐะฒ! ๐ฃ๏ธ๐ท+๐ฃ๏ธ๐ถ",
	"ะะพัะพะฝัะน ัะตะฑั(ะฐ) ะบะพัะพะปัะผ/ะบะพัะพะปะตะฒะพะน ะบะพะผะฟัะพะผะธััะฐ! ๐๐ค๐ท๐ถ",
	"ะขั - ะณะตะฝะตัะธัะตัะบะธะน ะฟะตััะตะบัะธะพะฝะธัั! ๐งฌโจ๐ท๐",
	"ะญัะพ ะทะฒะฐะฝะธะต ะดะฐัั +10 ะบ ัะฐัะธะทะผะต ะธ -5 ะบ ะปะพะณะธะบะต! ๐ฎ๐๐ท๐๐ถ",
	"ะขั ัะตะฟะตัั ะพัะธัะธะฐะปัะฝะพ ะทะฐะณะฐะดะบะฐ ะดะปั ะะฐัะฒะธะฝะฐ! ๐งโโ๏ธโ๐ท๐",
	"ะัะฐัะธัะบะฐ/ัะตััััะฝะบะฐ, ัั ัะพะฒะตััะธะป(ะฐ) ะฝะตะฒะพะทะผะพะถะฝะพะต! ๐๐ท๐ซ๐โก๏ธโ",
	"ะขั - ะถะธะฒะพะต ะดะพะบะฐะทะฐัะตะปัััะฒะพ, ััะพ ะฟัะธัะพะดะฐ ัะพะถะต ัะผะตะตั ัััะธัั! ๐ณ๐๐ท๐ถ",
}

var broadcastPhrases2 = []string{
	// ะะตัะฒัะต 10
	"ะญัะพ ะฑะตะทััะปะพะฒะฝะพ ััะฟะตั ๐",
	"ะญัะพ ะฐะฑัะพะปััะฝะพ, ััะพะฟัะพัะตะฝัะฝะพ, ะฑะตะทะพะณะพะฒะพัะพัะฝะพ ััะฟะตั! ๐ฅณ๐",
	"ะคะฐะบั: ัั ะฟะพะฑะตะดะธะป(ะฐ) ะฒ ะถะธะทะฝะธ! โ๐",
	"ะะฐะถะต ะะปะพะฝ ะะฐัะบ ะทะฐะฒะธะดัะตั ัะฐะบะพะผั ะดะพััะธะถะตะฝะธั! ๐๐",
	"ะญัะพ ััะฟะตั ััะพะฒะฝั 'ะธะทะพะฑััะป ะบะพะปะตัะพ'! ๐๐ก",
	"ะะพะถะฝะพ ัะผะตะปะพ ะฟะธัะฐัั ะฒ ัะตะทัะผะต! ๐โจ",
	"ะะฐะฑััะบะฐ ะฑัะดะตั ะณะพัะดะธัััั (ะธะปะธ ะฝะตะดะพัะผะตะฒะฐัั)! ๐ตโ๐",
	"ะญัะพ ะบัััะต, ัะตะผ ะฒัะธะณัะฐัั ะฒ ะปะพัะตัะตั! ๐ฐโก๏ธ๐",
	"ะััะพัะธั ะฑัะดะตั ะฟะพะผะฝะธัั ััะพั ะดะตะฝั! ๐๐",
	"ะขั ะฟะตัะตัะตะป(ะปะฐ) ะฝะฐ ะฝะพะฒัะน ััะพะฒะตะฝั ะฑััะธั! โฌ๏ธ๐งฌ",

	// ะกะปะตะดัััะธะต 30
	"ะญัะพ ััะพะฒะตะฝั ััะฟะตัะฐ 'ะฒัะธะณัะฐะป ะัะบะฐั ะทะฐ ะปััััั ัะพะปั ัะฒะธะฝะพัะพะฑะฐะบะธ'! ๐๐ฌ๐ท๐ถ",
	"ะขะฐะบะพะน ััะฟะตั ะฑัะฒะฐะตั ัะฐะท ะฒ ะถะธะทะฝะธ... ะตัะปะธ ะฟะพะฒะตะทัั! ๐๐ท๐",
	"ะญัะพ ะบัััะต, ัะตะผ ะฝะฐะนัะธ ะบะปะฐะด! ๐ฐ<๐๐ท๐ถ",
	"ะขั ะดะพััะธะณ(ะปะฐ) ะฟะธะบะฐ ะบะฐััะตัั... ัะฒะธะฝะพัะพะฑะฐะบะธ! ๐๐ท๐๏ธ๐",
	"ะญัะพ ััะฟะตั, ัะฐะดะธ ะบะพัะพัะพะณะพ ััะพะธะปะพ ัะพะดะธัััั! ๐ถโก๏ธ๐๐ท๐ถ",
	"ะะฐะถะต ะะ ะฟะพะทะฐะฒะธะดะพะฒะฐะป ะฑั ัะฐะบะพะผั ะดะพััะธะถะตะฝะธั! ๐ค๐โก๏ธ๐ท๐โ",
	"ะญัะพ ะบะฐะบ ะฒัะธะณัะฐัั ะดะถะตะบะฟะพั ะฒ ะณะตะฝะตัะธัะตัะบะพะผ ะบะฐะทะธะฝะพ! ๐ฐ๐ฐ๐ท๐งฌ๐ถ",
	"ะขั ะฟะพะนะผะฐะป(ะฐ) ัะดะฐัั ะทะฐ ัะฒะพัั... ะธ ะทะฐ ะฟััะฐัะพะบ! ๐๐+๐ท๐ฝ",
	"ะญัะพ ััะพะฒะตะฝั 'ั ะฟะพััะพะณะฐะป(ะฐ) ัะฐะดัะณั'! ๐โ๐ท๐ถ",
	"ะฃัะฟะตั ะฝะฐััะพะปัะบะพ ะณัะพะผะบะธะน, ััะพ ะตะณะพ ัะปััะฝะพ ั ะะฐััะฐ! ๐๐ท๐๐",
	"ะญัะพ ะบัััะต, ัะตะผ ััะฐัั ะผะตะผะพะผ! ๐ธ<๐ท๐ถ๐",
	"ะขั ะฒะพััะป(ะปะฐ) ะฒ ะธััะพัะธั ะบะฐะบ ััะฐะปะพะฝ ััะฟะตัะฐ! ๐๐ทโญ๐",
	"ะญัะพ ะบะฐะบ ะฝะฐะนัะธ ะธะณะพะปะบั ะฒ ััะพะณะต ัะตะฝะฐ... ะฑัะดััะธ ัะฒะธะฝะพัะพะฑะฐะบะพะน! ๐งต๐ท๐พ๐๐",
	"ะฃัะฟะตั ััะพะฒะฝั 'ะฟะตัะตัะธััะธะป(ะฐ) ะปะธัั'! ๐ฆ๐คโก๏ธ๐ท๐๐",
	"ะญัะพ ะบะฐะบ ะฒัะธะณัะฐัั ะทะพะปะพัะพ ะฝะฐ ะะปะธะผะฟะธะฐะดะต ะดะปั ะณะธะฑัะธะดะพะฒ! ๐ฅ๐๐ท๐",
	"ะขั ะฟัะตะฒะทะพััะป(ะปะฐ) ะฒัะต ะพะถะธะดะฐะฝะธั... ะดะฐะถะต ะฒะตัะตัะธะฝะฐัะฐ! ๐จโโ๏ธ๐ฒ๐ท๐",
	"ะญัะพ ััะฟะตั, ะบะพัะพััะน ะทะฐััะฐะฒะปัะตั ะฟะปะฐะบะฐัั ะพั ััะฐัััั! ๐ญ๐๐ท๐",
	"ะขั ะดะพะบะฐะทะฐะป(ะฐ), ััะพ ะฝะตะฒะพะทะผะพะถะฝะพะต ะฒะพะทะผะพะถะฝะพ! ๐ซโก๏ธโ๐ท๐ถ",
	"ะญัะพ ะบัััะต, ัะตะผ ััะฐัั ะทะฒะตะทะดะพะน TikTok! ๐ฑโญ<๐ท๐๐",
	"ะขั ัะพะฒะตััะธะป(ะฐ) ะฟะพะดะฒะธะณ, ะดะพััะพะนะฝัะน ัะฟะธัะตัะบะพะน ะฟะพัะผั! ๐๐ทโ๏ธ๐",
	"ะญัะพ ะบะฐะบ ะฝะฐะนัะธ ัะผััะป ะถะธะทะฝะธ... ะธ ััะพ ัะฒะธะฝะพัะพะฑะฐะบะฐ! ๐งโโ๏ธ๐ก=๐ท๐ถ",
	"ะฃัะฟะตั ะฝะฐััะพะปัะบะพ ัะปะฐะดะบะธะน, ััะพ ะฐะถ ะทัะฑั ัะฒะพะดะธั! ๐ญ๐ฌ๐ท๐",
	"ะขั ะฟะตัะตะฒะตัะฝัะป(ะฐ) ะผะธั... ัะฒะธะฝะพัะพะฑะฐััะตะณะพ ัะพะพะฑัะตััะฒะฐ! ๐๐๐ท๐",
	"ะญัะพ ะบะฐะบ ะฒัะธะณัะฐัั ะฒ ัะฐัะผะฐัั ั ััะฟะตัะบะพะผะฟัััะตัะฐ! โ๏ธ๐คโก๏ธ๐ทโ๐",
	"ะขั ะดะพััะธะณ(ะปะฐ) ะฟัะพัะฒะตัะปะตะฝะธั ัะตัะตะท ัััะบะฐะฝัะต ะธ ะปะฐะน! ๐งโโ๏ธ๐ทโธ๏ธ๐",
	"ะญัะพ ััะฟะตั, ะฟะตัะตะด ะบะพัะพััะผ ะผะตัะบะฝัั ะฒัะต ัะฒะพะธ ะฟัะตะดัะดััะธะต ะดะพััะธะถะตะฝะธั! โจ๐ท๐๐",
	"ะขั ััะฐะป(ะฐ) ะถะธะฒะพะน ะปะตะณะตะฝะดะพะน... ะธะปะธ ะฐะฝะตะบะดะพัะพะผ, ะฝะพ ะฒ ัะพัะพัะตะผ ัะผััะปะต! ๐๐๐ท๐",
	"ะญัะพ ะบัััะต, ัะตะผ ะธะทะพะฑัะตััะธ ะฒะตัะฝัะน ะดะฒะธะณะฐัะตะปั! โ๏ธโ<๐ท๐ถโจ",
	"ะขั ะดะพะบะฐะทะฐะป(ะฐ), ััะพ 1+1 ะธะฝะพะณะดะฐ ัะฐะฒะฝะพ ะณะตะฝะธะฐะปัะฝะพััะธ! 1๏ธโฃ+1๏ธโฃ=๐ท๐ถ๐",
	"ะญัะพ ััะฟะตั, ะบะพัะพััะน ะฒะพะนะดัั ะฒ ััะตะฑะฝะธะบะธ... ะฟะพ ะทะพะพะปะพะณะธะธ ัะผะตัะฐ! ๐๐๐ท๐",
	"ะญัะพ ััะฟะตั, ะบะพัะพััะน ะฝะต ะบัะฟะธัั ะทะฐ ะดะตะฝัะณะธ! ๐ธโโ",
}

// ะะพะฝััะฐะฝัั ะดะปั ะฝะฐัััะพะตะบ (ะพััะฐัััั ะบะฐะบ ะฑัะปะธ)
const (
	broadcastMaxWorkers     = 5
	broadcastStartDelay     = 800 * time.Millisecond
	broadcastGoroutineDelay = 50 * time.Millisecond
)

// getRandomBroadcastPhrase ะฒะพะทะฒัะฐัะฐะตั ัะปััะฐะนะฝัั ััะฐะทั ะธะท ะผะฐััะธะฒะฐ
func getRandomBroadcastPhrase(phrases []string) string {
	if len(phrases) == 0 {
		return "ะะพะทะดัะฐะฒะปัะตะผ! ๐" // ัะพะปะฑัะบ ะฝะฐ ัะปััะฐะน ะฟัััะพะณะพ ะผะฐััะธะฒะฐ
	}

	// ะะฝะธัะธะฐะปะธะทะธััะตะผ ะณะตะฝะตัะฐัะพั ัะปััะฐะนะฝัั ัะธัะตะป
	rand.Seed(time.Now().UnixNano())
	return phrases[rand.Intn(len(phrases))]
}

// SetupBroadcastHandler ัะพะทะดะฐัั HTTP ะพะฑัะฐะฑะพััะธะบ ะดะปั ัะฐัััะปะบะธ
func SetupBroadcastHandler(bot *tgbotapi.BotAPI, db *sql.DB, secretKey string) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		if !isAuthorized(r, secretKey) {
			log.Printf("โ ะะตะฐะฒัะพัะธะทะพะฒะฐะฝะฝัะน ะทะฐะฟัะพั ะพั %s", r.RemoteAddr)
			http.Error(w, "Unauthorized", http.StatusUnauthorized)
			return
		}

		log.Printf("๐ ะะฐะฟััะบ ัะฐัััะปะบะธ ะฟะพ ะทะฐะฟัะพัั ะพั %s", r.RemoteAddr)

		go func() {
			if err := SendSvynoSobakaBroadcast(bot, db); err != nil {
				log.Printf("โ ะัะธะฑะบะฐ ัะฐัััะปะบะธ: %v", err)
			}
		}()

		w.WriteHeader(http.StatusAccepted)
		w.Write([]byte("Svyno sobaka broadcast started"))
	}
}

// ะะฑัะฐะฑะพัะบะฐ ะพะดะฝะพะณะพ ัะฐัะฐ ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ ัััะตััะฒัััะตะน sendMessage ะธะท messages.go
func processChat(bot *tgbotapi.BotAPI, chatID int64, finalName string, wg *sync.WaitGroup, results chan<- string) {
	defer wg.Done()

	chatLog := fmt.Sprintf("ะงะฐั %d", chatID)

	// 1. ะะตัะฒะพะต ัะพะพะฑัะตะฝะธะต - ะธัะฟะพะปัะทัะตะผ ัััะตััะฒััััั sendMessage
	sendMessage(bot, chatID,
		"๐ ะะดัั ัะบะฐะฝะธัะพะฒะฐะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปะตะน ัะฐัะฐ ะฝะฐ ะฝะฐะปะธัะธะต ัะฒะธะฝะพัะพะฑะฐะบะธ",
		"ะฟะตัะฒะพะต ัะพะพะฑัะตะฝะธะต ัะฐัััะปะบะธ")

	// ะะพัะพัะบะฐั ะฟะฐัะทะฐ ะดะปั ัััะตะบัะฐ
	time.Sleep(broadcastStartDelay)

	// 2. ะัะพัะพะต ัะพะพะฑัะตะฝะธะต - ะธัะฟะพะปัะทัะตะผ ัะปััะฐะนะฝัะต ััะฐะทั
	phrase1 := getRandomBroadcastPhrase(broadcastPhrases1)
	phrase2 := getRandomBroadcastPhrase(broadcastPhrases2)

	msgText := fmt.Sprintf("๐ ะกะะะะะกะะะะะ ะะะฏ\n\n"+
		"ะกะตะณะพะดะฝั ัะฒะธะฝะพัะพะฑะฐะบะฐ โ ััะพ %s\n\n"+
		"%s\n"+
		"%s",
		finalName,
		phrase1,
		phrase2)

	log.Printf("๐ ะะปั ัะฐัะฐ %d ะฒัะฑัะฐะฝั ััะฐะทั:\n1: %s\n2: %s",
		chatID,
		phrase1[:min(30, len(phrase1))]+"...",
		phrase2[:min(30, len(phrase2))]+"...")

	sendMessage(bot, chatID, msgText, "ะฒัะพัะพะต ัะพะพะฑัะตะฝะธะต ัะฐัััะปะบะธ")

	results <- fmt.Sprintf("โ %s: ััะฟะตัะฝะพ ะพัะฟัะฐะฒะปะตะฝะพ", chatLog)
}

// ะัะฟะพะผะพะณะฐัะตะปัะฝะฐั ััะฝะบัะธั ะดะปั min (ััะพะฑั ะฝะต ะธะผะฟะพััะธัะพะฒะฐัั math)
func min(a, b int) int {
	if a < b {
		return a
	}
	return b
}

// SendSvynoSobakaBroadcast ะฒัะฟะพะปะฝัะตั ัะฐัััะปะบั ั ะฒัะฑะพัะพะผ ัะฒะธะฝะพัะพะฑะฐะบะธ ะดะฝั
func SendSvynoSobakaBroadcast(bot *tgbotapi.BotAPI, db *sql.DB) error {
	if db == nil {
		log.Println("โน๏ธ ะะ ะฝะต ะฝะฐัััะพะตะฝะฐ, ะฟัะพะฟััะบะฐะตะผ ัะฐัััะปะบั")
		return nil
	}

	log.Println("๐ข ะะฐัะธะฝะฐั ัะฐัััะปะบั ัะฒะธะฝะพัะพะฑะฐะบะธ ะดะฝั...")

	// ๐ข 1. ะะะะฎะงะะะะ ะะ - ะฒัะทะพะฒ ะฟัะพัะตะดััั
	log.Println("๐ ะัะทัะฒะฐะตะผ ะฟัะพัะตะดััั...")
	_, err := db.Exec(`CALL svyno_sobaka_bot.proc_svyno_sobaka_of_the_day()`)
	if err != nil {
		log.Printf("โ ะัะธะฑะบะฐ ะฒัะทะพะฒะฐ ะฟัะพัะตะดััั: %v", err)
	} else {
		log.Println("โ ะัะพัะตะดััะฐ ะฒัะฟะพะปะฝะตะฝะฐ")
	}

	// ๐ข 2. ะะะะฎะงะะะะ ะะ - ะทะฐะฟัะพั ะดะฐะฝะฝัั
	log.Println("๐ ะะฐะฟัะฐัะธะฒะฐะตะผ ะดะฐะฝะฝัะต...")

	// ะกะฝะฐัะฐะปะฐ ะฟะพััะธัะฐะตะผ ัะบะพะปัะบะพ ะทะฐะฟะธัะตะน ะทะฐ ัะตะณะพะดะฝั
	var totalRecords int
	countQuery := `SELECT COUNT(*) FROM svyno_sobaka_bot.svyno_sobaka_of_the_day WHERE dt_date_only = CURRENT_DATE`
	err = db.QueryRow(countQuery).Scan(&totalRecords)
	if err != nil {
		log.Printf("โ๏ธ ะะต ัะดะฐะปะพัั ะฟะพะดััะธัะฐัั ะทะฐะฟะธัะธ: %v", err)
		totalRecords = 0
	}

	log.Printf("๐ ะ ัะฐะฑะปะธัะต svyno_sobaka_of_the_day ะฝะฐะนะดะตะฝะพ %d ะทะฐะฟะธัะตะน ะทะฐ ัะตะณะพะดะฝั", totalRecords)

	// ะัะปะธ ะฝะตั ะทะฐะฟะธัะตะน - ะทะฐะฒะตััะฐะตะผ
	if totalRecords == 0 {
		log.Println("โน๏ธ ะะตั ะทะฐะฟะธัะตะน ะดะปั ัะฐัััะปะบะธ, ะทะฐะฒะตััะฐั ัะฐะฑะพัั")
		return nil
	}

	// ะะฐะฟัะฐัะธะฒะฐะตะผ ะดะตัะฐะปัะฝัะต ะดะฐะฝะฝัะต
	rows, err := db.Query(`
        SELECT 
            chat_id,
            COALESCE(user_username, user_name, 'ะะฝะพะฝะธะผ') as display_name,
            user_name,
            user_username
        FROM svyno_sobaka_bot.svyno_sobaka_of_the_day 
        WHERE dt_date_only = CURRENT_DATE
        ORDER BY chat_id
    `)

	if err != nil {
		log.Printf("โ ะัะธะฑะบะฐ ะทะฐะฟัะพัะฐ ะดะฐะฝะฝัั: %v", err)
		return err
	}

	// ๐ด 3. ะะซะะะฎะงะะะะ ะะ - ััะฐะทั ะฟะพัะปะต ะฟะพะปััะตะฝะธั ะดะฐะฝะฝัั
	defer rows.Close()
	log.Println("โ ะะฐะฝะฝัะต ะฟะพะปััะตะฝั, ะะ ะผะพะถะฝะพ ะทะฐะบััะฒะฐัั")

	// ะะพะดะณะพัะพะฒะบะฐ ะดะฐะฝะฝัั ะดะปั ะฟะฐัะฐะปะปะตะปัะฝะพะน ะพะฑัะฐะฑะพัะบะธ
	type ChatTask struct {
		ChatID    int64
		FinalName string
	}

	var tasks []ChatTask
	chatIDs := []int64{}

	for rows.Next() {
		var chatID int64
		var displayName, userName, userUsername sql.NullString

		if err := rows.Scan(&chatID, &displayName, &userName, &userUsername); err != nil {
			log.Printf("โ๏ธ ะัะธะฑะบะฐ ััะตะฝะธั ะดะฐะฝะฝัั ะดะปั ัะฐัะฐ: %v", err)
			continue
		}

		// ะคะพัะผะธััะตะผ ะธะผั
		var finalName string
		if userUsername.Valid && userUsername.String != "" {
			finalName = "@" + userUsername.String
		} else if userName.Valid && userName.String != "" {
			finalName = userName.String
		} else {
			finalName = "ะะฝะพะฝะธะผ"
		}

		tasks = append(tasks, ChatTask{ChatID: chatID, FinalName: finalName})
		chatIDs = append(chatIDs, chatID)

		log.Printf("๐ ะะพะฑะฐะฒะปะตะฝ ัะฐั %d: %s", chatID, finalName)
	}

	// ะัะพะฒะตััะตะผ ะพัะธะฑะบะธ rows
	if err := rows.Err(); err != nil {
		log.Printf("โ๏ธ ะัะธะฑะบะฐ ะฟัะธ ะธัะตัะฐัะธะธ rows: %v", err)
	}

	log.Printf("๐ ะัะตะณะพ ัะฐัะพะฒ ะดะปั ัะฐัััะปะบะธ: %d", len(tasks))

	// ะะะะะะะะะฌะะะฏ ะะะะะะะขะะ ั ัะตะผะฐัะพัะพะผ
	semaphore := make(chan struct{}, broadcastMaxWorkers)
	var wg sync.WaitGroup
	results := make(chan string, len(tasks))

	startTime := time.Now()
	log.Println("๐ ะะฐัะธะฝะฐั ะฟะฐัะฐะปะปะตะปัะฝัั ัะฐัััะปะบั...")

	// ะะฐะฟััะบะฐะตะผ ะฒะพัะบะตัั
	for _, task := range tasks {
		wg.Add(1)
		semaphore <- struct{}{} // ะะฐะฝะธะผะฐะตะผ ัะปะพั ะฒ ัะตะผะฐัะพัะต

		go func(chatID int64, finalName string) {
			defer func() {
				<-semaphore // ะัะฒะพะฑะพะถะดะฐะตะผ ัะปะพั
			}()

			processChat(bot, chatID, finalName, &wg, results)
		}(task.ChatID, task.FinalName)

		// ะะธะฝะธะผะฐะปัะฝะฐั ะทะฐะดะตัะถะบะฐ ะผะตะถะดั ะทะฐะฟััะบะฐะผะธ ะณะพัััะธะฝ
		time.Sleep(broadcastGoroutineDelay)
	}

	// ะะดัะผ ะทะฐะฒะตััะตะฝะธั ะฒัะตั ะณะพัััะธะฝ
	go func() {
		wg.Wait()
		close(results)
	}()

	// ะกะพะฑะธัะฐะตะผ ัะตะทัะปััะฐัั
	successCount := 0
	failCount := 0

	for result := range results {
		log.Println(result)
		if strings.HasPrefix(result, "โ") {
			successCount++
		} else {
			failCount++
		}
	}

	duration := time.Since(startTime)

	// ะกัะฐัะธััะธะบะฐ
	log.Printf("๐ ะะฐัััะปะบะฐ ะทะฐะฒะตััะตะฝะฐ ะทะฐ %v", duration)
	log.Printf("๐ ะกัะฐัะธััะธะบะฐ:")
	log.Printf("   ะัะตะณะพ ัะฐัะพะฒ: %d", len(tasks))
	log.Printf("   ะฃัะฟะตัะฝะพ ะพัะฟัะฐะฒะปะตะฝะพ: %d", successCount)
	log.Printf("   ะะต ัะดะฐะปะพัั ะพัะฟัะฐะฒะธัั: %d", failCount)

	// ะะฐัััะธััะฒะฐะตะผ ะฟัะธะผะตัะฝะพะต ะฒัะตะผั ะดะปั 100 ัะฐัะพะฒ
	if len(tasks) > 0 {
		timePerChat := duration / time.Duration(len(tasks))
		estimated100 := timePerChat * 100 / time.Duration(broadcastMaxWorkers)
		log.Printf("โฑ๏ธ  ะัะธะผะตัะฝะพะต ะฒัะตะผั ะดะปั 100 ัะฐัะพะฒ: %v", estimated100)
	}

	return nil
}

// isAuthorized ะฟัะพะฒะตััะตั ะฐะฒัะพัะธะทะฐัะธั
func isAuthorized(r *http.Request, secretKey string) bool {
	if strings.HasPrefix(r.RemoteAddr, "127.0.0.1") ||
		strings.HasPrefix(r.RemoteAddr, "[::1]") {
		return true
	}

	if r.Header.Get("X-Broadcast-Secret") == secretKey {
		return true
	}

	userAgent := strings.ToLower(r.UserAgent())
	if strings.Contains(userAgent, "yandex") ||
		strings.Contains(userAgent, "cloud") {
		return true
	}

	return false
}
