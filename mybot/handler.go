package mybot

import (
	"database/sql"
	"log"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

// HandleMessage - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
func HandleMessage(bot *tgbotapi.BotAPI, msg *tgbotapi.Message,
	forwardChatID int64, db *sql.DB, botUsername string) {

	log.Printf("üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç @%s: %s", msg.From.UserName, msg.Text)

	// ===============================================
	// 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î (–µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞)
	// ===============================================
	if db != nil {
		SaveMessageToDB(db, botUsername, msg)
	}

	// ===============================================
	// 2. –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
	// ===============================================
	forwardMessage(bot, msg, forwardChatID)

	// ===============================================
	// 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–≥ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —á–∞—Ç
	// ===============================================
	SendMessageLog(bot, msg, botUsername, bot.Self.ID)

	// ===============================================
	// 4. –ö–æ–º–∞–Ω–¥—ã
	// ===============================================
	if msg.IsCommand() {
		handleCommand(bot, msg)
	}

	// ID —á–∞—Ç–∞ –¥–ª—è –ª–æ–≥–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤)
	logChatID := int64(-1003655803421)

	// ===============================================
	// 5. –ü–†–û–í–ï–†–ö–ê –í–°–ï–• –¢–†–ò–ì–ì–ï–†–û–í (–û–ë–™–ï–î–ò–ù–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
	// ===============================================
	if CheckAllTriggers(bot, msg, logChatID, db) {
		return // –¢—Ä–∏–≥–≥–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–ª, –¥–∞–ª—å—à–µ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º
	}
}
