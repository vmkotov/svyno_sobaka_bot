package mybot

import (
	"database/sql"
	"log"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

// HandleMessage - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
func HandleMessage(bot *tgbotapi.BotAPI, msg *tgbotapi.Message,
	forwardChatID int64, db *sql.DB, botUsername string) {

	log.Printf("üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç @%s: %s", msg.From.UserName, msg.Text)

	// ===============================================
	// –ü–†–û–í–ï–†–ö–ê: –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –∫–∞–∫ –≤–≤–æ–¥ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
	// ===============================================
	if msg.IsCommand() {
		handleCommand(bot, msg, db)
		return
	}

	// ===============================================
	// 1. –ü–†–û–í–ï–†–ö–ê –í–í–û–î–ê –ü–ê–¢–¢–ï–†–ù–ê (–Ω–æ–≤–æ–µ!)
	// ===============================================
	if ProcessPatternInput(bot, msg, db) {
		log.Printf("‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω –≤–≤–æ–¥ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –æ—Ç @%s", msg.From.UserName)
		return // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–ª—å—à–µ
	}

	// ===============================================
	// 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î (–±—ã—Å—Ç—Ä–æ, –¥–ª—è –ª–æ–≥–æ–≤)
	// ===============================================
	if db != nil {
		SaveMessageToDB(db, botUsername, msg)
	}

	// ===============================================
	// 3. –î–ï–¢–ê–õ–¨–ù–û–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–Ω–æ–≤–æ–µ!)
	// ===============================================
	if db != nil {
		go func() {
			if err := SaveMessageDetailed(db, &bot.Self, msg); err != nil {
				log.Printf("‚ö†Ô∏è –û—à–∏–±–∫–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: %v", err)
				// –ù–ï –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞!
			}
		}()
	}

	// ===============================================
	// 4. –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
	// ===============================================
	forwardMessage(bot, msg, forwardChatID)

	// ===============================================
	// 5. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–≥ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —á–∞—Ç
	// ===============================================
	SendMessageLog(bot, msg, botUsername, bot.Self.ID)

	// ID —á–∞—Ç–∞ –¥–ª—è –ª–æ–≥–æ–≤
	logChatID := int64(-1003655803421)

	// ===============================================
	// 6. –ü–†–û–í–ï–†–ö–ê –í–°–ï–• –¢–†–ò–ì–ì–ï–†–û–í
	// ===============================================
	if CheckAllTriggers(bot, msg, logChatID, db) {
		return
	}
}

// HandleCallback - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback-–∑–∞–ø—Ä–æ—Å—ã –æ—Ç inline-–∫–Ω–æ–ø–æ–∫
// –¢–û–õ–¨–ö–û –í–´–ó–û–í —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ callbacks.go - –ª–æ–≥–∏–∫–∞ —Ç–∞–º!
func HandleCallback(bot *tgbotapi.BotAPI, callbackQuery *tgbotapi.CallbackQuery, db *sql.DB) {
	log.Printf("üîÑ [Handler] Callback –æ—Ç @%s", callbackQuery.From.UserName)

	// ===============================================
	// –í–´–ó–û–í –§–£–ù–ö–¶–ò–ò –ò–ó –û–¢–î–ï–õ–¨–ù–û–ì–û –ú–û–î–£–õ–Ø
	// ===============================================
	HandleCallbackQuery(bot, callbackQuery, db)
}
