package bot

import (
	"log"
	
	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

/*
üì¶ MessageForwarder - –ü–µ—Ä–µ—Å—ã–ª–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏ Telegram

–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢:
1. –ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. MessageForwarder –¥–µ–ª–∞–µ—Ç "forward" (–ø–µ—Ä–µ—Å—ã–ª–∫—É) —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –¥—Ä—É–≥–æ–π —á–∞—Ç
3. –í —Ü–µ–ª–µ–≤–æ–º —á–∞—Ç–µ –≤–∏–¥–Ω–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥–ø–∏—Å—å—é "–ø–µ—Ä–µ—Å–ª–∞–Ω–æ –æ—Ç..."

–ó–ê–ß–ï–ú –ù–£–ñ–ï–ù:
‚Ä¢ –ú–æ–¥–µ—Ä–∞—Ü–∏—è: –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
‚Ä¢ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∞—Ä—Ö–∏–≤–Ω—ã–π —á–∞—Ç  
‚Ä¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
‚Ä¢ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ: –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –¥—Ä—É–≥–æ–π —á–∞—Ç

–ü–ï–†–ï–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –í –î–†–£–ì–ò–• –ë–û–¢–ê–•:
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç
2. –î–æ–±–∞–≤—å—Ç–µ –≤ main.go —Å–æ–∑–¥–∞–Ω–∏–µ forwarder (–∫–∞–∫ –≤ —ç—Ç–æ–º –±–æ—Ç–µ)
3. –í—ã–∑—ã–≤–∞–π—Ç–µ Forward() —Ç–∞–º, –≥–¥–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
*/

// MessageForwarder - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –∫–æ—Ç–æ—Ä–∞—è —É–º–µ–µ—Ç –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
// –ú–æ–∂–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ "–ø–æ—á—Ç–∞–ª—å–æ–Ω–∞": –æ–Ω –±–µ—Ä–µ—Ç –ø–∏—Å—å–º–æ (—Å–æ–æ–±—â–µ–Ω–∏–µ) 
// –∏ –æ—Ç–Ω–æ—Å–∏—Ç –µ–≥–æ –≤ –¥—Ä—É–≥–æ–π –ø–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ (—á–∞—Ç)
type MessageForwarder struct {
	// bot - —ç—Ç–æ –Ω–∞—à Telegram –±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
	// –≠—Ç–æ –∫–∞–∫ —Ä—É–∫–∞ –ø–æ—á—Ç–∞–ª—å–æ–Ω–∞ - –±–µ–∑ –Ω–µ—ë –Ω–µ–ª—å–∑—è –Ω–∏—á–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
	bot           *tgbotapi.BotAPI
	
	// forwardChatID - ID —á–∞—Ç–∞, –∫—É–¥–∞ –º—ã –±—É–¥–µ–º –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
	// –≠—Ç–æ –∫–∞–∫ –∞–¥—Ä–µ—Å –¥–æ–º–∞, –∫—É–¥–∞ –Ω—É–∂–Ω–æ –¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ
	// ID —á–∞—Ç–∞ - —ç—Ç–æ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: -1001234567890 –¥–ª—è —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø—ã
	forwardChatID int64
}

/*
NewMessageForwarder - —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ "–ø–æ—á—Ç–∞–ª—å–æ–Ω–∞"

–ü–ê–†–ê–ú–ï–¢–†–´:
‚Ä¢ bot - –Ω–∞—à Telegram –±–æ—Ç (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∂–µ —Å–æ–∑–¥–∞–Ω –≤ main.go)
‚Ä¢ forwardChatID - ID —á–∞—Ç–∞-–ø–æ–ª—É—á–∞—Ç–µ–ª—è (–∫—É–¥–∞ –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å)

–ü–†–ò–ú–ï–† –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø:
forwarder := NewMessageForwarder(myBot, -1001234567890)
*/
func NewMessageForwarder(bot *tgbotapi.BotAPI, forwardChatID int64) *MessageForwarder {
	// –°–æ–∑–¥–∞–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤–æ–≥–æ "–ø–æ—á—Ç–∞–ª—å–æ–Ω–∞"
	return &MessageForwarder{
		bot:           bot,           // –î–∞–µ–º –ø–æ—á—Ç–∞–ª—å–æ–Ω—É —Ä—É–∫—É (–±–æ—Ç–∞)
		forwardChatID: forwardChatID, // –ò –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (ID —á–∞—Ç–∞)
	}
}

/*
Forward - –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–∫–∞–∫ –µ—Å—Ç—å", –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢ –í–ù–£–¢–†–ò:
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ø–æ—á—Ç–∞–ª—å–æ–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ (–µ—Å—Ç—å –±–æ—Ç –∏ –∞–¥—Ä–µ—Å)
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —ç—Ç–æ –Ω–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–∞–º–æ–≥–æ –±–æ—Ç–∞ (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è)
3. –°–æ–∑–¥–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É "–ø–µ—Ä–µ—Å–ª–∞—Ç—å" –¥–ª—è Telegram API
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É –∏ –ø–∏—à–µ—Ç –≤ –ª–æ–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–ê–†–ê–ú–ï–¢–†:
‚Ä¢ msg - —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–ª–∞—Ç—å (–ø–æ–ª—É—á–µ–Ω–æ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
*/
func (mf *MessageForwarder) Forward(msg *tgbotapi.Message) {
	// –ü–†–û–í–ï–†–ö–ê 1: –£ –ø–æ—á—Ç–∞–ª—å–æ–Ω–∞ –µ—Å—Ç—å –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ?
	// –ï—Å–ª–∏ –Ω–µ—Ç –±–æ—Ç–∞ –∏–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ - –≤—ã—Ö–æ–¥–∏–º
	if mf.forwardChatID == 0 || mf.bot == nil {
		return // –ù–µ –º–æ–∂–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
	}

	// –ü–†–û–í–ï–†–ö–ê 2: –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç —Å–∞–º–æ–≥–æ –±–æ—Ç–∞?
	// –ß—Ç–æ–±—ã –±–æ—Ç –Ω–µ –ø–µ—Ä–µ—Å—ã–ª–∞–ª —Å–∞–º —Å–µ–±–µ —Å–≤–æ–∏ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª!)
	if msg.From != nil && msg.From.ID == mf.bot.Self.ID {
		return // –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –Ω–∞—Å —Å–∞–º–∏—Ö, –Ω–µ –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º
	}

	// –°–û–ó–î–ê–ï–ú –ö–û–ú–ê–ù–î–£ "–ü–ï–†–ï–°–õ–ê–¢–¨":
	// NewForward —Å–æ–∑–¥–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –∫–æ–º–∞–Ω–¥—É –¥–ª—è Telegram
	// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: (–∫—É–¥–∞, –æ—Ç–∫—É–¥–∞, ID_—Å–æ–æ–±—â–µ–Ω–∏—è)
	forward := tgbotapi.NewForward(mf.forwardChatID, msg.Chat.ID, msg.MessageID)
	
	// –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ö–û–ú–ê–ù–î–£:
	// –í—ã–∑—ã–≤–∞–µ–º —É –±–æ—Ç–∞ –º–µ—Ç–æ–¥ Send —Å –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥–æ–π
	if _, err := mf.bot.Send(forward); err != nil {
		// ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å - –ø–∏—à–µ–º –≤ –ª–æ–≥ –æ—à–∏–±–∫—É
		log.Printf("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç %d: %v", mf.forwardChatID, err)
	} else {
		// ‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ - –ø–∏—à–µ–º –≤ –ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
		log.Printf("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ –≤ —á–∞—Ç %d", mf.forwardChatID)
	}
}

/*
ForwardWithCaption - –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é (caption)

–ß–ï–ú –û–¢–õ–ò–ß–ê–ï–¢–°–Ø –û–¢ Forward():
‚Ä¢ –û–±—ã—á–Ω—ã–π forward –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–∫–∞–∫ –µ—Å—Ç—å"
‚Ä¢ ForwardWithCaption –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–≤–µ—Ä—Ö—É —Ç–µ–∫—Å—Ç-–ø–æ—è—Å–Ω–µ–Ω–∏–µ
‚Ä¢ –ü—Ä–∏–º–µ—Ä: "‚ö†Ô∏è –í–∞–∂–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ò–≤–∞–Ω"

–ü–û–ß–ï–ú–£ –ù–ï–õ–¨–ó–Ø –î–û–ë–ê–í–ò–¢–¨ –ü–û–î–ü–ò–°–¨ –ö –û–ë–´–ß–ù–û–ú–£ FORWARD:
‚Ä¢ Telegram API –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å –∫ forward
‚Ä¢ –ü–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º CopyMessage (–∫–æ–ø–∏—é) –≤–º–µ—Å—Ç–æ forward

–ü–ê–†–ê–ú–ï–¢–†–´:
‚Ä¢ msg - —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏
‚Ä¢ caption - —Ç–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∏ (–ø–æ—è—Å–Ω–µ–Ω–∏–µ)
*/
func (mf *MessageForwarder) ForwardWithCaption(msg *tgbotapi.Message, caption string) {
	// –ü–†–û–í–ï–†–ö–ò (—Ç–∞–∫–∏–µ –∂–µ –∫–∞–∫ –≤ Forward)
	if mf.forwardChatID == 0 || mf.bot == nil {
		return
	}

	if msg.From != nil && msg.From.ID == mf.bot.Self.ID {
		return
	}

	// –°–û–ó–î–ê–ï–ú –ö–û–ú–ê–ù–î–£ "–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –° –ü–û–î–ü–ò–°–¨–Æ":
	// NewCopyMessage —Å–æ–∑–¥–∞–µ—Ç –∫–æ–ø–∏—é —Å–æ–æ–±—â–µ–Ω–∏—è, –∫ –∫–æ—Ç–æ—Ä–æ–π –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å
	copyMsg := tgbotapi.NewCopyMessage(mf.forwardChatID, msg.Chat.ID, msg.MessageID)
	copyMsg.Caption = caption // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à—É –ø–æ–¥–ø–∏—Å—å
	
	// –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ö–û–ü–ò–Æ:
	if _, err := mf.bot.CopyMessage(copyMsg); err != nil {
		log.Printf("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥–ø–∏—Å—å—é –≤ —á–∞—Ç %d: %v", mf.forwardChatID, err)
	} else {
		log.Printf("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥–ø–∏—Å—å—é –ø–µ—Ä–µ—Å–ª–∞–Ω–æ –≤ —á–∞—Ç %d", mf.forwardChatID)
	}
}

/*
üìã –ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø:

1. –ü–†–û–°–¢–ê–Ø –ü–ï–†–ï–°–´–õ–ö–ê (–≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π):
   forwarder.Forward(message)

2. –ü–ï–†–ï–°–´–õ–ö–ê –° –ü–û–î–ü–ò–°–¨–Æ (–¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏):
   forwarder.ForwardWithCaption(message, "üö® –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")

3. –ü–ï–†–ï–°–´–õ–ö–ê –¢–û–õ–¨–ö–û –ö–û–ú–ê–ù–î (–¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è):
   if message.IsCommand() {
       forwarder.ForwardWithCaption(message, "üìã –ö–æ–º–∞–Ω–¥–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
   }

4. –ü–ï–†–ï–°–´–õ–ö–ê –¢–û–õ–¨–ö–û –ò–ó –û–ü–†–ï–î–ï–õ–ï–ù–ù–´–• –ß–ê–¢–û–í:
   if message.Chat.ID == 123456 {
       forwarder.Forward(message)
   }
*/
